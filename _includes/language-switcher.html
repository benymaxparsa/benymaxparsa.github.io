<!-- Language Switcher -->
<style>
.language-switcher {
  display: inline-block;
  margin-left: 10px;
}

.language-switcher select {
  background: transparent;
  border: 1px solid #bbb;
  border-radius: 4px;
  color: inherit;
  padding: 5px 10px;
  font-size: 0.9em;
  cursor: pointer;
  transition: all 0.3s ease;
}

.language-switcher select:hover {
  border-color: #00adb5;
}

.language-switcher select:focus {
  outline: none;
  border-color: #00adb5;
}

@media (max-width: 768px) {
  .language-switcher {
    margin-left: 5px;
  }
  
  .language-switcher select {
    padding: 4px 8px;
    font-size: 0.85em;
  }
}
</style>

<div class="language-switcher">
  <select id="language-select" onchange="changeLanguage(this.value)" aria-label="Select language">
    <option value="en" {% if page.lang == 'en' or page.lang == nil %}selected{% endif %}>English</option>
    <option value="fr" {% if page.lang == 'fr' %}selected{% endif %}>Français (Québec)</option>
  </select>
</div>

<script>
function changeLanguage(lang) {
  const currentPath = window.location.pathname;
  let newPath;
  
  if (lang === 'fr') {
    // Switch to French
    if (currentPath.startsWith('/fr/')) {
      newPath = currentPath;
    } else if (currentPath === '/' || currentPath === '') {
      newPath = '/fr/';
    } else {
      // Remove trailing slash if present
      const cleanPath = currentPath.replace(/\/$/, '');
      newPath = '/fr' + cleanPath;
    }
  } else {
    // Switch to English
    if (currentPath.startsWith('/fr/')) {
      newPath = currentPath.replace('/fr/', '/');
      if (newPath === '/') {
        newPath = '/';
      }
    } else {
      newPath = currentPath;
    }
  }
  
  // Store language preference
  localStorage.setItem('preferredLanguage', lang);
  
  window.location.href = newPath;
}

// Load language preference on page load
window.addEventListener('DOMContentLoaded', function() {
  const preferredLang = localStorage.getItem('preferredLanguage');
  const currentPath = window.location.pathname;
  const isOnFrenchPage = currentPath.startsWith('/fr/');
  const hasRedirected = sessionStorage.getItem('languageRedirected');
  
  // Update select to match current page
  if (isOnFrenchPage) {
    document.getElementById('language-select').value = 'fr';
  } else {
    document.getElementById('language-select').value = 'en';
  }
  
  // Only auto-redirect if there's a mismatch, a preference is set, and we haven't redirected in this session
  if (!hasRedirected && preferredLang && 
      ((preferredLang === 'fr' && !isOnFrenchPage) || 
       (preferredLang === 'en' && isOnFrenchPage))) {
    // Only redirect on the home page to avoid breaking direct links
    if (currentPath === '/' || currentPath === '/fr/') {
      sessionStorage.setItem('languageRedirected', 'true');
      changeLanguage(preferredLang);
    }
  }
});
</script>
